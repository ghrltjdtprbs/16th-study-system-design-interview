# 1장. 사용자 수에 따른 규모 확장성
## 단일 서버 시스템
### a. 단일 서버가 모든 요청을 처리한다.
<img width="500" alt="image" src="https://github.com/user-attachments/assets/11ccfde8-8b7a-41f8-b508-8a3bd0183a64" />

사용자가 늘어 서버 하나로 부하를 감당할 수 없다면?
### b. 웹 계층과 데이터 계층 서버를 분리한다.
<img width="500" alt="image" src="https://github.com/user-attachments/assets/ea880504-b89a-480a-b5c4-156656c1af9b" />

웹 계층 서버와 데이터 계층 서버를 분리하면 각각을 독립적으로 확장해 나갈 수 있다.

- 현재 설계에서 사용자는 웹 서버에 바로 연결된다. 
  - 웹 서버가 다운되면 사이트에 접속할 수 없다.
  - 너무 많은 사용자가 접속하여 웹서버가 한계에 도달하면 응답 속도가 느려지거나 접속이 불가능해진다.
## 수직적 규모 확장 vs 수평적 규모 확장
### 수직적 확장 (scale up)
- 서버에 고사양 자원을 추가하는 행위
- 장점:
  - 단순
  - 유입 트래픽 양 적을 때 적절
- 단점:
  - 한 대의 서버에 CPU나 메모리를 무한대로 증설 불가
  - SPOF에 대한 대응 불가
  - 비용 문제
따라서, 대규모 애플리케이션은 scale out이 보다 적절하다. 
### 수평적 규모 확장 (scale out)
- 서버의 개수를 늘려 성능을 개선하는 행위
- 장점:
  - 장애 복구
  - 가용성 향상
  - 무한대에 가까운 확장 가능
- 단점:
  - 복잡도 증가

#### 로드밸런서
- 부하 분산 집합에 속한 웹 서버들에게 트래픽을 고르게 분산
<img width="500" alt="image" src="https://github.com/user-attachments/assets/8f5d384d-5e9c-426b-bf57-7aee6585c585" />

- 특정 서버가 죽으면 다른 서버로 트래픽 전송하여 서비스 전체가 다운되는 문제 방지
- 트래픽이 급증하여 웹 서버 계층에 서버를 추가하면 로드 밸런서가 자동으로 트래픽 분산

그렇다면, 데이터 계층에서는 트래픽 증가에 어떻게 대응할 수 있을까?
#### 데이터베이스 다중화
<img width="500" alt="image" src="https://github.com/user-attachments/assets/b09f0655-49e1-4107-9074-efc494455f0c" />

- Master-Slave
  - Master: 쓰기 연산 지원
  - Slave: 읽기 연산 지원, 사본 저장
- 장점:
  - 성능 향상: 읽기 연산 분산으로 병렬로 처리될 수 있는 질의 수 증가
  - 안정성: 데이터베이스 서버 일부 파괴되어도 데이터 보존
  - 가용성: SPOF 방지
- 단점:
  - 복제 지연
- 부 서버가 다운되면, 한시적으로 주 데이터베이스가 읽기 연산 처리 or 부 서버 추가
- 주 서버가 다운되면, 부 서버를 주 서버로 승격

그렇다면, 응답 시간은 어떻게 개선해볼 수 있을까?
## 캐시
- 비싼 연산 결과 or 자주 참조되는 데이터를 메모리 안에 두어 연산 처리 속도 향상
- 데이터베이스 부하 감소
- 전략
  - 캐시할 데이터 종류, 크기, 접근 패턴에 맞는 전략 선택
  - 읽기 주도형 캐시 전략
    - 캐시에 데이터가 있으면 반환
    - 없으면 데이터베이스 질의로 데이터 찾아 캐시에 저장 후 반환
- 고려 사항
  - 언제 필요한가?
    - 갱신은 자주 일어나지 않지만, 참조는 빈번할 때
  - 어떤 데이터를 캐시에 둘 것인가?
    - 휘발성 메모리에 두므로, 영속적을 보관할 데이터는 적합하지 않다.
  - 데이터는 어떻게 만료되는가?
    - 만료 기한이 너무 짧으면 데이터베이스 질의가 빈번
    - 만료 기한이 너무 길면 오래된 데이터 참조 가능성 증가
  - 일관성은 어떻게 유지되는가?
    - 저장소의 원본 갱신 연산과 캐시 갱신 연산이 단일 트랜잭션으로 처리되지 않으면 일관성 깨질 수 있다.
  - 장애에 어떻게 대처할 것인가?
    - SPOF 방지
  - 캐시 메모리 사이즈는 어떻게 잡을 것인가?
    - 메모리가 너무 작으면 자주 캐시에서 밀려나 성능 저하
  - 데이터 방출 정책은 무엇인가?
    - LRU, LFU, FIFO 등 상황에 맞게 고려
<img width="500" alt="image" src="https://github.com/user-attachments/assets/4c842789-3b77-4853-87af-c0d8d4913edb" />

## CDN
- 정적 콘텐츠를 지리적으로 분산된 서버에 캐싱하여 응답 속도 향상
<img width="500" alt="image" src="https://github.com/user-attachments/assets/7e68cee7-94df-4777-836c-c198bb6a4ad3" />

- 장점:
  - 원본 서버 부하 감소
  - 가까운 서버에서 콘텐츠 가져오므로 응답 시간 단축
- 고려 사항
  - 비용: 데이터 전송 양에 따른 요금 부과
  - 만료 기한 설정: 시의성이 중요한 콘텐츠의 경우 만료 시점 잘 정해야 함
  - 장애 대응: CDN이 죽은 경우 어떻게 동작해야 하는지 고려
  - 콘텐츠 무효화: 제공되는 API 사용, 오브젝트 버저닝 이용
<img width="500" alt="image" src="https://github.com/user-attachments/assets/32f34090-6a0e-47de-a9cd-357ac40b2bfc">

## 무상태 웹 계층
### a. 상태 정보 의존적인 아키텍처
- 상태를 유지하여 요청 간 공유
- 문제: 클라이언트로부터의 요청은 항상 같은 서버로 전송
  - sticky -session
  - 로드 밸런서 부담 증가, 장애 처리 복잡도 증가
### b. 무상태 아키텍처
- 상태 정보는 웹 서버로부터 물리적으로 분리
- 상태 정보가 필요할 경우 공유 저장소로부터 조회
<img width="500" alt="image" src="https://github.com/user-attachments/assets/9c01beb1-2a98-4002-b4a0-c69db9349b53" />

## 데이터 센터
- 가용성을 높이고 전 세계 어디서든 쾌적하게 사용하기 위해 여러 데이터 센터를 지원
- 통상 가까운 데이터 센터로 안내 (지리적 라우팅)
- 특정 데이터 센터 중 하나에 심각한 장애 발생하면 모든 트래픽은 장애가 없는 데이터 센터로 전송
- 고려 사항
  - 트래픽 우회: 올바른 데이터 센터로 트래픽 보낼 방법 고안 ex) GeoDNS
  - 데이터 동기화: 데이터 센터마다 별도의 데이터베이스 사용 시 데이터 정합성 보장
  - 테스트와 배포: 여러 위치에서 테스트 진행, 자동화된 배포 도구의 사용

## 메시지 큐
- 메세지의 무손실 보장
- 비동기 통신 지원
<img width="500" alt="image" src="https://github.com/user-attachments/assets/5aed8b33-9cdf-49fb-bfe7-5576e4acf030" />

- 장점:
  - 서버 간 결합 느슨해져 규모 확장성 보장되어야 하는 애플리케이션 구성에 적합
    - 생산자: 소비자 프로세스 다운되도 메세지 발행 가능
    - 소비자: 생산자 서비스가 가용한 상태가 아니더라도 메시지 수신
## 로그, 메트릭, 자동화
- 로그: 에러 로그 모니터링
- 메트릭: 시스템 상태 파악
  - 호스트 단위 메트릭: CPU, 메모리, 디스크 I/O 등
  - 종합 메트릭: 데이터베이스 계층 성능, 캐시 계층 성능 등
  - 핵심 비즈니스 메트릭: DAU, 수익, 재방문 등
## 데이터베이스의 규모 확장
### scale up
- 고성능 자원 증설
- 단점:
  - 무한대로 증설 불가
  - SPOF 위험
  - 비용 증가
### scale out
- 서버 증설
#### 샤딩
- 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술
  - ex) 사용자 ID에 % 연산으로 샤드 결정
- 샤드 간 데이터 중복 없음
- 장점:
  - 데이터 분산으로 서버 부하 감소
  - 데이터베이스 크기 무한대 증설 가능
- 단점:
  - 샤딩 키 설계 오류로 데이터 불균형 발생 가능
  - 조인 연산 복잡도 증가, 재샤딩 필요 가능성
- 고려 사항
  - 재샤딩
    - 데이터 많아져서 하나의 샤드로 감당이 어려울 때
    - 샤드 간 데이터 분포가 균등하지 않아 특정 햐드에 공간 소모가 빨리 진행될 때 (샤드 소진)
  - 유명인사 문제 (핫스팟 키)
    - 특정 샤드에 질의가 집중되어 서버에 과부하
  - 조인과 비정규화
    - 여러 샤드에 걸친 데이터 조인의 어려움
    - 역정규화로 질의 단순화
## 마무리
시스템 규모 확장을 위한 기법
1. 무상태 웹 계층
2. 계층별 다중화 도입을 통한 SPOF 방지 및 가용성 증가
3. 데이터 캐싱을 통한 서버 부하 감소 및 응답 속도 개선
4. 여러 데이터 센터 지원
5. CDN을 통한 응답 속도 개선
6. 샤딩을 통한 데이터 계층 규모 확장
7. 각 계층은 독립적인 서비스로 분할
8. 시스템을 모니터링, 자동화 도구 활용

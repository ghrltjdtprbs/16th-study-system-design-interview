# 11장 결제 시스템

## 1. 문제 이해 및 설계 범위 확정

### 기능 요구사항

- **대금 수신(pay-in)**: 결제 시스템이 판매자를 대신하여 고객으로부터 대금을 수령한다.
- **대금 정산(pay-out)**: 결제 시스템이 전 세계의 판매자에게 제품 판매 대금을 송금한다.

### 비기능 요구사항

- **신뢰성 및 내결함성**: 결제 실패는 신중하게 처리해야 한다.
- **비동기 조정 프로세스**: 내부 서비스와 외부 서비스 간의 결제 정보가 일치하는지를 비동기적으로 확인한다.

### 개략적인 규모 추정

- 하루 약 100만 건의 트랜잭션을 처리해야 하며, 이는 초당 약 10건의 트랜잭션 처리량에 해당한다.

---

## 2. 개략적 설계안 제시

### 대금 수신 흐름

- 사용자가 결제를 요청하면, 결제 이벤트가 생성되어 결제 서비스에 전달된다.
- 결제 서비스는 해당 이벤트를 DB에 저장하고, 필요 시 다수의 결제 주문을 생성한다.
- 결제 실행자는 각 결제 주문을 PSP를 통해 처리한다.
- 결제 성공 시 지갑 서비스를 통해 판매자의 잔고가 갱신되며, 이후 원장 서비스로 결제 기록이 전달된다.

### 주요 컴포넌트 설명

- **결제 실행자**: 결제 이벤트 수락 및 전반적인 결제 흐름을 조율한다.
- **위험 확인 서비스**: 제3자 서비스로, 결제의 위험도를 평가한다.
- **결제 실행자**: 각 결제 주문을 PSP를 통해 실행한다.
- **PSP**: 실제 금전 이동을 담당하는 외부 결제 서비스 제공자이다.
- **카드유형(카드사)**: 비자, 마스터카드 등 신용카드 결제를 처리하는 조직이다.
- **원장**: 복식부기에 따라 거래를 기록하며, 회계 및 정산의 기준이 된다.
- **지갑**: 판매자의 계정 잔고를 추적하고 관리한다.

### 결제 서비스 API

- `POST /v1/payments`: 결제 이벤트 실행
- `GET /v1/payments/{id}`: 단일 결제 주문의 실행 상태 반환

### 데이터 모델

- 주요 테이블: `결제 이벤트`, `결제 주문`
[결제 시스템용 저장소 고를 때 고려사항]
- 성능보다 안정성 검증 
- 모니터링/데이터 탐사 도구 지원 정도
- DBA 채용 가능?

### 복식부기 원장 시스템
- 원장 시스템 중요 설계 원친 -> 복식부기
- 복식부기 : 모든 결제 시스템에 필수 요소/정확한 기록을 남기는 데 핵심적 역할을 한다.
- 모든 결제 거래를 2개의 별도 원장 계좌에 같은 금액으로 기록
ex) 한 계좌에서는 차감이 이루어지고 다른 계좌에는 입금이 이루어진다.
  
### 외부 결제 페이지
  신용 카드 정보를 취급하지 않기 위해 기업들은 PSP에서 제공하는 외부 신용 카드 페이지 사용

### 대금 정산 흐름
타사 정산 서비스를 사용하여 전자상거래 웹사이트 은행 계좌에서 판매자 은행 계좌로 돈을 이체
일반적으로 결제 시스템은 대금 정산을 위해 외상 매입금 지급 서비스 제공업체 이용
---

## 3. 상세 설계

### PSP 연동
1. 사용자가 클라이언트 브라우저에서 결제 버튼을 클릭 -> 결제 서비스 호출
2. 결제 서비스 -> 결제 등록 요청을 PSP로 전송
3. PSP는 결제 서비스에 토큰을 반환한다.
4. 결제 서비스는 PSP가 제공하는 토큰을 db에 저장한다.
5. 클라이언트에게 (PSP 제공) 외부 결제 페이지를 표시한다.
6. 사용자는 결제 세부 정보를 PSP의 웹 페이지에 입력한 다음 결제 버튼을 클릭
7. PSP가 결제 상태 반환
8. 비동기적으로 PSP는 웹훅을 통해 결제 상태와 함께 결제 서비스를 호출한다.

### 조정 프로세스

- 정산 파일과 원장 데이터를 비교하여 일치 여부를 확인 
- 자동화 불가능한 작업은 대기열에 등록하여 재무팀에서 처리한다.

### 결제 지연 처리

- 결제가 지연 상태로 반환될 경우, 클라이언트는 해당 상태를 사용자에게 표시한다.
- PSP는 지연된 결제를 추적하며 상태 변경 시 웹훅으로 알린다.

### 내부 서비스 간 통신 방식

- **동기 통신**: 빠른 응답이 필요하지만 결합도가 높고 장애 격리가 어려움
- **비동기 통신**: 확장성과 유연성이 높음. 메시지 큐를 활용한 이벤트 기반 처리 가능

결제 시스템에서는 비동기 통신이 더 나은 선택

### 결제 실패 처리

- 결제 상태는 데이터 추가만 가능한 테이블에 저장한다.
- 실패 시에는 실패 메시지 큐로 이동시키고, 재시도 가능/불가에 따라 재시도 큐에 이동
- 재시도 전략: 즉시 재시도, 고정 간격, 증분 간격, 지수적 백오프, 취소

### 멱등성

- `멱등 키`(UUID)를 HTTP 헤더에 추가하여 동일 결제 요청의 중복 실행을 방지한다.

### 일관성 유지

- 데이터 불일치 방지를 위해 멱등성과 조정 프로세스를 병행 적용한다.
- 모든 읽기/쓰기를 주 데이터베이스에서 처리하거나 합의 알고리즘을 통한 데이터 동기화를 활용한다.

---

## 4. 결제 보안 설계

| 문제 | 해결책 |
|------|--------|
| 요청/응답 도청 | HTTPS 사용 |
| 데이터 변조 | 암호화 및 무결성 모니터링 강화 |
| 중간자 공격 | 인증서 고정 및 SSL 사용 |
| 데이터 손실 | 다지역 DB 복제 및 스냅샷 |
| DDoS 공격 | 처리율 제한 및 방화벽 사용 |
| 카드 도난 | 결제 정보 토큰화 |
| 규제 준수 | PCI DSS 준수 |
| 사기 | 주소 확인, CVV 검증, 사용자 행동 분석 등 |

